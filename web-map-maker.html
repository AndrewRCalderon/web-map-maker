

<!DOCTYPE html>
<html>
<head>
	<title>Web map maker</title>
	<meta charset="utf-8" />
    <link rel="stylesheet" href="http://latimes-graphics-media.s3.amazonaws.com/styles/leaflet-extra.css" />  
    <script src="http://latimes-graphics-media.s3.amazonaws.com/js/leaflet-0.7.2.js"></script>
    <script src="http://latimes-graphics-media.s3.amazonaws.com/js/geocode-wpt.js"></script>
	
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.css' rel='stylesheet' />
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
	
	<script type="text/javascript" src="js/jquery.geocodify.js"></script>
	<script type="text/javascript" src="../mapbox-token.js"></script>
	
	<script src="js/html2canvas.js"></script>
	<script src="js/base64.js"></script>
	<script src="js/canvas2image.js"></script>
	
	<link rel="stylesheet" href="styles/jquery.geocodify.css"/>
	
	<style type="text/css" media="screen">
	input.geocodify {
		width:275px;
	    font-size: inherit;
	    line-height: inherit;
	    padding: 2px 2px;
	    
	}
	input:focus {
	    border: 1px solid #2262CC;
	}
	.leaflet-control-zoom{display:none;}
	.mapbox-improve-map{display:none;}
	.header{text-transform: uppercase; font-weight:bold; font-family:Arial; font-size:12px;}
	.leaflet-popup-content-wrapper{background-color:#000;}
	.leaflet-popup-content{font:bold 34px/36px Arial; color: white;}
	.leaflet-popup .leaflet-zoom-animated{bottom:0px !important;}
	.leaflet-control-attribution {font-size: 22px !important;height:26px; color:#777; padding:4px 0 0 9px;}
 	.leaflet-control-attribution a{display:none;}
	.leaflet-control-scale-line{font-size: 16px !important;height:26px;border: 2px solid #999; border-color: rgba(0,0,0,.4);border-top: 0;}
	.leaflet-marker-icon {display:none;}
	.leaflet-popup-tip-container {
		width: 20px;
		height: 27px;
		margin: 0 auto;
		position: relative;
		background-image: url('shaddow.png');
		background-position: center bottom;
	}
	.leaflet-popup-tip {
		border-top: 20px solid #000;
		box-shadow: none;
		
	}
	</style>
	
	<!-- http://a.tiles.mapbox.com/v4/marker/pin-l+000.png?access_token=pk.eyJ1IjoibGF0aW1lc21hcHBpbmciLCJhIjoiRS1kbVVXUSJ9.J1a8i4qHde5LxpUMuXq9JQ -->
</head>
<body style="padding:15px">
	<!-- <div id="map"></div> -->
	<h1>Web map maker <span style="font-size:16px; font-weight:normal;">(use Safari or Chrome browsers)</span></h1>
	<p style="font-size:20px;color:#666;">This tool is for aproximate location only. Geocoders can mislocate addresses by small distances.</p>
	
	<label for="mapPicker">1. Choose a base map</label>
	<select id="mapPicker">
	  <option value="latimesmapping.db744287" >Quiet World</option>
	  <option value="latimesmapping.e47fff09" >Relief World</option>x
	</select>
	<span style="font-family:arial; font-size:12px; color:#666;"> &nbsp;State boundaries are available in U.S. only.</span>
	<br/><br/>
	
	<label for="popupText">2. Write popup text </label>
	<input class="geocodify" type="text" id="popupText" style="width:250px;padding: 2px 2px;" maxlength="40" placeholder="40 chars max">
	<br/><br/>
		
	<label for="address"  >3. Search</label>
	<input type="text" id="address"  placeholder="Enter a complete address">
	<input type="button" onclick="findAddress()" id="addressBtn" value="GO"> <span style="font-family:arial; font-size:12px; color:#666;"> &nbsp;City names now produce popups</span><br /> <br />
	
	<label for="lat"  >... Or enter Latitude:</label>
	<input class="geocodify" type="text" id="lat" style="width:100px; padding: 2px 2px;"  placeholder="34.052010">  
	<label for="lon"  >&nbsp; Longitude:</label>
	<input class="geocodify" type="text" id="lon" style="width:100px; padding: 2px 2px;" placeholder="-118.245796">
	<input type="button" onclick="findLatLon()" id="latLonBtn" value="GO">
	
	<br/><br/>
	
	<label >4. Adjust your zoom (scrollwheel).</label>
	<p style="font-family:arial; font-size:12px; color:#666;">Do not zoom in super close unless you are 100% confident of a location. </p>
	<br/>
	
	<label >5. Move the map around so that the location is identifiable.</label>
	<div id="minimap">
		
	</div>
	
	<br/><br/>

	<div id="web_blank">
		<p class="header">Click to <input type="button" id="colwSave" value="Create an image"/></p>
		<div id="map_web" style="width:1300px; height:731px"></div>	 
	</div>
  
	
	<script>
	
	//L.mapbox.accessToken = 'YOUR API KEY';

	
	document.getElementById('mapPicker').addEventListener('change',function(){
	         changeTiles(this.value);
	    });
	
	
	/***  little hack starts here ***/
	L.Map = L.Map.extend({
		 openPopup: function(popup) {
		 //        this.closePopup();  // just comment this
		 this._popup = popup;

		 return this.addLayer(popup).fire('popupopen', {
		                                  popup: this._popup
		                                  });
		 }
	}); /***  end of hack ***/ /***  end of hack ***/
	
	
	var map_web = L.map('map_web',{attributionControl: true});
	map_web.attributionControl.setPrefix('&copy; Los Angeles Times, &copy; Mapbox, &copy; OpenStreetMap');
	map_web.attributionControl.removeAttribution(
				'Mapbox' )
	
	
	function changeTiles(value){
		L.mapbox.tileLayer(value).addTo(map_web);
	}
	changeTiles('latimesmapping.db744287');
	

	L.control.scale().addTo(map_web);
	
	
	
	var maxY = 34.34343606848294;
    var minY = 33.66263917576218;
    var minX = -118.685302734375;
    var maxX = -118.10302734375;

    $("#address").geocodify({
        onSelect: function (result) {
            console.log(result);
        },
        regionBias: 'US',
        viewportBias: new google.maps.LatLngBounds(
             new google.maps.LatLng(33.22030778968541,-118.948974609375),
             new google.maps.LatLng(35.0120020431607,-117.44384765625)
         ),
        filterResults: function(results) {
            return _.filter(results, function(addy) {
                return _.some(addy.address_components, function(component) {
                    return component.long_name === 'Los Angeles County';
                });
            });
        }
    });
	
	var geocoder = L.mapbox.geocoder('mapbox.places-v1');
	geocoder.query('los angeles, CA', setMap);

	function findAddress(){
		var getInput = document.getElementById('address').value;
		geocoder.query(getInput, showMap);	

    
		document.getElementsByClassName('leaflet-popup').style.bottom="0px"
	}

	function setMap(err, data) {
	    // The geocoder can return an area, like a city, or a
	    // point, like an address. Here we handle both cases,
	    // by fitting the map bounds to an area or zooming to a point.
    
	    if (data.lbounds) {
			map_web.fitBounds(data.lbounds);
	    } else if (data.latlng) {
			map_web.setView([data.latlng[0], data.latlng[1]], 13);			
	    }
	}

	
	function showMap(err, data) {
	    // The geocoder can return an area, like a city, or a
	    // point, like an address. Here we handle both cases,
	    // by fitting the map bounds to an area or zooming to a point.
    
	    if (data.lbounds) {
			map_web.fitBounds(data.lbounds);
	    } else if (data.latlng) {
			map_web.setView([data.latlng[0], data.latlng[1]], 13);
			
			
			
			
	    }
		
		marker=L.marker([data.latlng[0], data.latlng[1]], {
		    icon: L.mapbox.marker.icon({
		        'marker-size': 'large',
		        'marker-color': '#fff'
		    })
		});
		marker.addTo(map_web);
		
		var getPopup = document.getElementById('popupText').value;
  
		marker.bindPopup(getPopup, {offset: new L.Point(0, 0)}).openPopup();//, closeOnClick: false
	}
	
	
	
	function findLatLon(){
		var getLat = document.getElementById('lat').value;
		var getLon = document.getElementById('lon').value;
		
		map_web.setView([getLat, getLon], 10);
		
		marker=L.marker([getLat, getLon], 
			{
		    icon: L.mapbox.marker.icon({
		        'marker-size': 'small',
		        'marker-color': '#fff'
		    }
		)
		});
		
		marker.addTo(map_web);
		
		var getPopup = document.getElementById('popupText').value;
		marker.bindPopup(getPopup, {offset: new L.Point(0, 0)}).openPopup();
	}
	
	//
	// add enter key functionality   841 n alexandria ave los angeles
	
	var go = document.getElementById("addressBtn");
	var txt = document.getElementById("address");

	txt.addEventListener("keypress", function() {
	    if (event.keyCode == 13) go.click();
	});
	

		

	
	
	//<![CDATA[ 
	$(window).load(function(){
	$(function() { 
			
		
	    $("#colwSave").click(function() { 
			var newInstructions=document.createElement('p');
			newInstructions.id ='newInstructions'
			newInstructions.innerHTML ='<strong>Right-click the image below to save/download.</strong>';
			document.body.appendChild(newInstructions);
	        html2canvas($("#map_web"), {
				useCORS: true,
				
	            onrendered: function(canvas)  {
	                theCanvas = canvas;
					
									
	                document.body.appendChild(canvas);

	                // Convert and download as image 
	                // Canvas2Image.saveAsPNG(canvas);
	                $("#img-out").append(canvas);
					window.scrollTo(0,document.body.scrollHeight);
	                // Clean up 
	                //document.body.removeChild(canvas);
	            }
	        });
	    });
	}); 

	});//]]>  
	
	
	
		setMaxSearchZoom = 12; 
	
	</script>
	

</body>
</html>
	